---
- name: Ensure the user exists
  user:
    name: "{{ vm_user }}"
    state: present

- name: Set user password
  user:
    name: "{{ vm_user }}"
    password: "{{ vm_password | password_hash('sha512') }}"
    update_password: always

- name: Set root password (Debian only)
  user:
    name: root
    password: "{{ root_password | password_hash('sha512') }}"
    update_password: always
  when:
    - ansible_facts.distribution == "Debian"

- name: Debug - Passwords updated
  debug:
    msg: >-
      Password updated for user {{ vm_user }}
      {% if ansible_facts.distribution == "Debian" %}
      and root
      {% endif %}
